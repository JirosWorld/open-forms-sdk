import {ArgsTable, Canvas, Meta, Story} from '@storybook/addon-docs';
import {expect, jest} from '@storybook/jest';
import {userEvent, waitFor, within} from '@storybook/testing-library';

import {LiteralsProvider} from 'components/Literal';

import LoginOptions from '.';
import LoginOptionsDisplay from './LoginOptionsDisplay';

<Meta
  title="Composites/Login Options"
  component={LoginOptions}
  parameters={{
    docs: {
      source: {
        type: 'dynamic',
        excludeDecorators: true,
      },
    },
  }}
  argTypes={{
    form: {table: {disable: true}},
  }}
/>

# Login Options

The `LoginOptions` component displays the options that are available for a user to authenticate when
starting a form.

## Presentation

The `LoginOptionsDisplay` component shows the different buttons that can be clicked to start the
authentication process. Next to each button, the corresponding logo is displayed.

export const DisplayTemplate = ({loginAsYourselfOptions, loginAsGemachtigdeOptions}) => (
  <form
    onSubmit={e => {
      e.preventDefault();
      alert('anonymous form start');
    }}
  >
    <LoginOptionsDisplay
      loginAsYourselfOptions={loginAsYourselfOptions}
      loginAsGemachtigdeOptions={loginAsGemachtigdeOptions}
    />
  </form>
);

<Canvas>
  <Story
    name="Display"
    argTypes={{
      onFormStart: {table: {disable: true}},
    }}
    args={{
      loginAsYourselfOptions: [
        {
          identifier: 'digid',
          label: 'DigiD',
          logo: {
            appearance: 'dark',
            href: 'https://www.digid.nl/',
            title: 'DigiD',
            imageSrc: './digid.png',
          },
          url: '#',
        },
        {
          identifier: 'eHerkenning',
          label: 'eHerkenning',
          logo: {
            appearance: 'light',
            href: 'https://www.eherkenning.nl/',
            title: 'eHerkenning',
            imageSrc: './eherkenning.png',
          },
          url: '#',
        },
        {
          identifier: 'eidas',
          label: 'eIDAS',
          logo: {
            appearance: 'light',
            href: 'https://www.eherkenning.nl/',
            title: 'eIDAS',
            imageSrc: './eidas.png',
          },
          url: '#',
        },
        {
          identifier: 'anonymous',
          label: 'Begin form',
        },
      ],
      loginAsGemachtigdeOptions: [
        {
          identifier: 'digid_machtigen',
          label: 'DigiD Machtigen',
          logo: {
            appearance: 'dark',
            href: 'https://www.digid.nl/',
            title: 'DigiD Machtigen',
            imageSrc: './digid.png',
          },
          url: '#',
        },
      ],
    }}
  >
    {DisplayTemplate.bind({})}
  </Story>
</Canvas>

Note that the anonymous form start option is implemented as a button with `type="submit"` and is
therefore expected to be nested inside of a `<form>` element with an appropriate `onSubmit` handler.

### Props

<ArgsTable of={LoginOptionsDisplay} />

## Functional

The `LoginOptions` component handles the 'smart' part of the component. It separates the login
options between the ones that can be used to 'login as yourself' and the ones that can be used to
log in 'on behalf of someone else'. It also formats the labels that will be displayed on the buttons
and creates the right URL to which the user will be redirected upon clicking one of the buttons.

export const LiteralDecorator = (Story, {args}) => (
  <LiteralsProvider literals={{beginText: {resolved: args.beginText}}}>
    <Story />
  </LiteralsProvider>
);

export const Template = ({loginRequired = false, loginOptions, onFormStart}) => (
  <LoginOptions
    form={{
      uuid: '81a22589-abce-4147-a2a3-62e9a56685aa',
      name: 'Test form',
      loginRequired,
      loginOptions,
      translationEnabled: false,
      autoLoginAuthenticationBackend: '',
      paymentRequired: false,
      paymentOptions: [],
      literals: {
        previousText: {resolved: 'Previous page', value: ''},
        beginText: {resolved: 'Begin form', value: ''},
        changeText: {resolved: 'Change', value: ''},
        confirmText: {resolved: 'Confirm', value: ''},
      },
      slug: 'test-form',
      url: `<placeholder>`,
      steps: [],
      showProgressIndicator: true,
      maintenanceMode: false,
      active: true,
      explanationTemplate: '<p>Toelichtingssjabloon...</p>',
      submissionAllowed: 'yes',
      requiredFieldsWithAsterisk: true,
    }}
    onFormStart={onFormStart}
  />
);

<Canvas>
  <Story
    name="Functional"
    decorators={[LiteralDecorator]}
    play={async ({args, canvasElement}) => {
      const canvas = within(canvasElement);
      let anonymousStartButton = await canvas.getByRole('button');
      await userEvent.click(anonymousStartButton);
      await waitFor(() => expect(args.onFormStart).toHaveBeenCalled());
    }}
    argTypes={{
      onFormStart: {
        action: true,
      },
    }}
    args={{
      beginText: 'Begin form (anonymous)',
      loginRequired: false,
      loginOptions: [
        {
          identifier: 'digid',
          label: 'DigiD',
          url: '#',
          logo: {
            title: 'DigiD simulatie',
            imageSrc: './digid.png',
            href: 'https://www.digid.nl/',
            appearance: 'dark',
          },
          isForGemachtigde: false,
        },
        {
          identifier: 'eherkenning',
          label: 'eHerkenning',
          url: '#',
          logo: {
            title: 'eHerkenning',
            imageSrc: './eherkenning.png',
            href: 'https://www.eherkenning.nl/',
            appearance: 'light',
          },
          isForGemachtigde: false,
        },
        {
          identifier: 'eidas',
          label: 'eIDAS',
          url: '#',
          logo: {
            title: 'eIDAS',
            imageSrc: './eidas.png',
            href: 'https://digital-strategy.ec.europa.eu/en/policies/eu-trust-mark',
            appearance: 'light',
          },
          isForGemachtigde: false,
        },
        {
          identifier: 'digid_machtigen',
          label: 'DigiD Machtigen',
          url: '#',
          logo: {
            title: 'DigiD Machtigen',
            imageSrc: './digid.png',
            href: 'https://www.digid.nl/',
            appearance: 'dark',
          },
          isForGemachtigde: true,
        },
        {
          identifier: 'eherkenning_bewindvoering',
          label: 'eHerkenning bewindvoering',
          url: '#',
          logo: {
            title: 'eHerkenning bewindvoering',
            imageSrc: './eherkenning.png',
            href: 'https://www.eherkenning.nl/',
            appearance: 'light',
          },
          isForGemachtigde: true,
        },
      ],
      onFormStart: jest.fn(e => e.preventDefault()),
    }}
  >
    {Template.bind({})}
  </Story>
</Canvas>

<Canvas>
  <Story
    name="No \'machtigen\' options"
    decorators={[LiteralDecorator]}
    argTypes={{
      onFormStart: {
        action: true,
      },
    }}
    args={{
      beginText: '(anonymous)',
      loginRequired: true,
      loginOptions: [
        {
          identifier: 'digid',
          label: 'DigiD',
          url: '#',
          logo: {
            title: 'DigiD simulatie',
            imageSrc: './digid.png',
            href: 'https://www.digid.nl/',
            appearance: 'dark',
          },
          isForGemachtigde: false,
        },
      ],
      onFormStart: jest.fn(e => {
        e.preventDefault();
        alert('form start triggered');
      }),
    }}
  >
    {Template.bind({})}
  </Story>
</Canvas>

### Props

<ArgsTable of={LoginOptions} />
