import {ArgsTable, Canvas, Meta, Story} from '@storybook/addon-docs';
import {expect} from '@storybook/jest';
import {userEvent, within} from '@storybook/testing-library';

import {ConfigDecorator, FormikDecorator} from 'story-utils/decorators';

import ProductSelect from './ProductSelect';
import {mockAppointmentProductsGet} from './mocks';

export const Template = () => <ProductSelect name="product" />;

<Meta
  title="Private API / Appointments / ProductSelect"
  decorators={[FormikDecorator, ConfigDecorator]}
  component={ProductSelect}
  parameters={{
    formik: {
      initialValues: {
        product: '',
      },
    },
    msw: {
      handlers: [mockAppointmentProductsGet],
    },
  }}
/>

<Canvas>
  <Story
    name="Data from API endpoint"
    play={async ({canvasElement}) => {
      // test that the options are fetched from the API endpoint
      const canvas = within(canvasElement);
      await expect(canvas.queryByText('Paspoort aanvraag')).toBeNull();
      const dropdown = canvas.getByLabelText('Product');
      await dropdown.focus();
      await userEvent.keyboard('[ArrowDown]');
      await expect(await canvas.findByText('Paspoort aanvraag')).toBeVisible();
    }}
  >
    {Template.bind({})}
  </Story>
</Canvas>

<ArgsTable of={ProductSelect} />
