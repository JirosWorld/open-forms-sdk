import {Canvas, Meta, Story} from '@storybook/addon-docs';
import {expect} from '@storybook/jest';
import {userEvent, within} from '@storybook/testing-library';

import {ConfigDecorator, FormikDecorator} from 'story-utils/decorators';

import DateSelect from './DateSelect';
import {mockAppointmentDatesGet} from './mocks';

<Meta
  title="Private API / Appointments / Fields / DateSelect"
  decorators={[FormikDecorator, ConfigDecorator]}
  component={DateSelect}
  parameters={{
    formik: {
      initialValues: {
        products: [{productId: 'e8e045ab', amount: 1}],
        location: '1396f17c',
        date: '',
      },
    },
    msw: {
      handlers: [mockAppointmentDatesGet],
    },
  }}
/>

## Disable dates outside of range

The API returns a set of available dates. All dates before and all dates after this range must be
marked as disabled, as they are not available dates.

<Canvas>
  <Story name="Calendar with available date range" height="460px">
    <DateSelect />
  </Story>
</Canvas>

## Disable missing dates within range

The set of available dates returned by the API can be sparse, e.g. to exclude Saturdays and Sundays
because appointments during the weekend are not possible, or because a date is already fully booked.
These gaps must be marked as disabled dates.

<Canvas>
  <Story
    name="Calendar with disabled gaps in date range"
    height="460px"
    parameters={{
      formik: {
        initialValues: {
          products: [{productId: 'e8e045ab', amount: 1}],
          location: '34000e85',
          date: '',
        },
      },
    }}
  >
    <DateSelect />
  </Story>
</Canvas>

## No location selected (yet)

A date can only be selected if a location is picked, as it is required input for the API endpoint.

<Canvas>
  <Story
    name="Calendar disabled when no location is set"
    parameters={{
      formik: {
        initialValues: {
          products: [{productId: 'e8e045ab', amount: 1}],
          location: '',
          date: '',
        },
      },
    }}
    play={async ({canvasElement}) => {
      const canvas = within(canvasElement);
      await expect(canvas.getByLabelText('Date')).toBeDisabled();
      await userEvent.click(canvas.getByLabelText('Date'));
      await expect(await canvas.queryByRole('dialog')).not.toBeInTheDocument();
    }}
  >
    <DateSelect />
  </Story>
</Canvas>

## No available dates available at all

When no appointment dates are available, instead we render an informative message.

<Canvas>
  <Story
    name="No dates available"
    parameters={{
      formik: {
        initialValues: {
          products: [{productId: 'e8e045ab', amount: 1}],
          location: 'no-date',
          date: '',
        },
      },
    }}
  >
    <DateSelect />
  </Story>
</Canvas>

## Single date available

<Canvas>
  <Story
    name="Single date available"
    height="460px"
    parameters={{
      formik: {
        initialValues: {
          products: [{productId: 'e8e045ab', amount: 1}],
          location: 'single-date',
          date: '',
        },
      },
    }}
  >
    <DateSelect />
  </Story>
</Canvas>
