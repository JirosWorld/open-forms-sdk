import {Canvas, Meta, Story} from '@storybook/addon-docs';
import {expect} from '@storybook/jest';
import {userEvent, within} from '@storybook/testing-library';

import {ConfigDecorator, FormikDecorator} from 'story-utils/decorators';

import TextField from './TextField';

export const Template = args => <TextField {...args} />;

<Meta
  title="Pure React Components / Forms / TextField"
  component={TextField}
  decorators={[FormikDecorator]}
  parameters={{
    formik: {
      initialValues: {
        test: '',
      },
    },
  }}
/>

<Canvas>
  <Story
    name="Default"
    play={async ({canvasElement}) => {
      const canvas = within(canvasElement);
      await expect(canvas.getByRole('textbox')).toBeVisible();
      await expect(canvas.getByText('test')).toBeVisible();
      await expect(canvas.getByText('This is a custom description')).toBeVisible();
      // Check if clicking on the label focuses the input
      const label = canvas.getByText('test');
      userEvent.click(label);
      await expect(canvas.getByRole('textbox')).toHaveFocus();
    }}
    args={{
      name: 'test',
      id: 'test',
      label: 'test',
      description: 'This is a custom description',
      disabled: false,
      isRequired: true,
    }}
  >
    {Template.bind({})}
  </Story>
</Canvas>

## Validation errors

<Canvas>
  <Story
    name="Validation error"
    parameters={{
      formik: {
        initialValues: {
          textinput: 'some text',
        },
        initialErrors: {
          textinput: 'invalid',
        },
      },
    }}
    args={{
      name: 'textinput',
      label: 'Text field',
      description: 'Description above the errors',
      disabled: false,
      isRequired: true,
    }}
    play={async ({canvasElement}) => {
      const canvas = within(canvasElement);
      await expect(canvas.getByText('invalid')).toBeVisible();
    }}
  >
    {Template.bind({})}
  </Story>
</Canvas>

## No asterisks

The backend can be configured to treat fields as required by default and instead mark optional
fields explicitly.

<Canvas>
  <Story
    name="No asterisk for required"
    decorators={[ConfigDecorator]}
    parameters={{
      config: {
        requiredFieldsWithAsterisk: false,
      },
    }}
    args={{
      name: 'test',
      label: 'Default required',
      isRequired: true,
    }}
  >
    {Template.bind({})}
  </Story>
</Canvas>
