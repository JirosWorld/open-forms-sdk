import {ArgsTable, Canvas, Meta, Story} from '@storybook/addon-docs';
import {expect} from '@storybook/jest';
import {waitFor, waitForElementToBeRemoved, within} from '@storybook/testing-library';

import {ConfigContext} from 'Context';
import {BASE_URL} from 'api-mocks';
import {mockLanguageChoicePut, mockLanguageInfoGet} from 'components/LanguageSelection/mocks';
import {ConfigDecorator, DeprecatedRouterDecorator} from 'story-utils/decorators';

import App from './App';

<Meta
  title="Private API/App"
  component={App}
  decorators={[ConfigDecorator, DeprecatedRouterDecorator]}
  argTypes={{
    form: {
      control: false,
    },
  }}
  args={{
    'form.translationEnabled': true,
  }}
  parameters={{
    msw: {
      handlers: [
        mockLanguageInfoGet([
          {code: 'nl', name: 'Nederlands'},
          {code: 'en', name: 'English'},
        ]),
        mockLanguageChoicePut,
      ],
    },
  }}
/>

export const Template = args => {
  const form = {
    uuid: '81a22589-abce-4147-a2a3-62e9a56685aa',
    name: 'Mocked form',
    loginRequired: false,
    translationEnabled: args['form.translationEnabled'],
    loginOptions: [],
    autoLoginAuthenticationBackend: '',
    paymentRequired: false,
    paymentOptions: [],
    literals: {
      previousText: {resolved: 'Previous page', value: ''},
      beginText: {resolved: 'Begin form', value: ''},
      changeText: {resolved: 'Change', value: ''},
      confirmText: {resolved: 'Confirm', value: ''},
    },
    slug: 'jest',
    url: 'http://127.0.0.1:8000/api/v2/forms/81a22589-abce-4147-a2a3-62e9a56685aa',
    steps: [
      {
        uuid: 'fc9f2889-b1e4-4045-b88c-acf1adf716cb',
        slug: 'step1',
        formDefinition: 'Stap 1',
        index: 0,
        literals: {
          previousText: {resolved: 'Previous page', value: ''},
          saveText: {resolved: 'Save current information', value: ''},
          nextText: {resolved: 'Next', value: ''},
        },
        url: 'http://127.0.0.1:8000/api/v2/forms/81a22589-abce-4147-a2a3-62e9a56685aa/steps/fc9f2889-b1e4-4045-b88c-acf1adf716cb',
      },
    ],
    showProgressIndicator: true,
    maintenanceMode: false,
    active: true,
    explanationTemplate: '<p>Toelichtingssjabloon...</p>',
    submissionAllowed: 'yes',
    requiredFieldsWithAsterisk: true,
  };
  return <App form={form} noDebug />;
};

# The App

The App component is the top level router. It's responsible for rendering the outer most layout and
rendering:

- `Form` based on the `form` config that is passed with the shape from the backend API.
- the language selection component if translations are enabled. Note that the render target is
  provided via the `I18NManager` component.

<Canvas>
  <Story
    name="Default"
    parameters={{
      docs: {
        source: {
          type: 'dynamic',
          excludeDecorators: true,
        },
      },
    }}
  >
    {Template.bind({})}
  </Story>
</Canvas>

<ArgsTable of={App} />

## Translations

If translations are enabled on the form, a `LanguageSelector` is rendered:

<Canvas>
  <Story
    name="Translation Enabled"
    parameters={{
      docs: {
        source: {
          type: 'dynamic',
          excludeDecorators: true,
        },
      },
    }}
    args={{
      'form.translationEnabled': true,
    }}
    play={async ({args, canvasElement}) => {
      const langSelector = await within(canvasElement).findByText(/^nl$/i);
      await expect(langSelector).toBeTruthy();
    }}
  >
    {Template.bind({})}
  </Story>
</Canvas>

If they are not, no `LanguageSelector` is rendered:

<Canvas>
  <Story
    name="Translation Disabled"
    args={{
      'form.translationEnabled': false,
    }}
    play={async ({args, canvasElement}) => {
      const canvas = within(canvasElement);
      // wait for spinners to disappear
      const spinners = document.querySelectorAll('.openforms-loading__spinner');
      await Promise.all(Array.from(spinners).map(waitForElementToBeRemoved));
      // assert there's no NL button
      const langSelector = canvas.queryByText(/^nl$/i);
      await expect(langSelector).toBeNull();
    }}
  >
    {Template.bind({})}
  </Story>
</Canvas>
